tinymce.PluginManager.add("link42",function(editor,url){var windowWidth=window.innerWidth,windowHeight=window.innerHeight;windowWidth=Math.min(Math.round(.9*windowWidth),600),windowHeight=Math.round(.7*windowHeight),editor.addButton("link42",{icon:"link",tooltip:"Insert/edit link",onPostRender:function(){var ctrl=this;editor.on("NodeChange",function(e){ctrl.disabled(!(editor.selection.getContent().length>0))})},onclick:function(){var linkUrl=editor.editorManager.settings.link_url,linkSaveUrl=editor.editorManager.settings.link_save_url,linkId="",node=editor.selection.getNode();if("A"==node.nodeName){var regex=new RegExp("###([0-9]+)###"),matched=regex.exec(node.href);null!==matched&&"undefined"!=typeof matched[1]&&(linkId=matched[1])}linkId.length>0&&(linkUrl+=linkId+"/"),editor.windowManager.open({title:"Link",url:linkUrl,width:windowWidth,height:windowHeight,buttons:[{text:"Save",onclick:function(e){var frame=$(e.currentTarget).find("iframe").get(0),content=frame.contentDocument,selectedItem=$(content).find("input#linkSelection"),linkData=selectedItem.val();return linkData=angular.fromJson(linkData),angular.isUndefined(linkData.linkType)?void editor.windowManager.close():void jQuery.ajax({url:linkSaveUrl,type:"POST",data:angular.toJson({id:linkData.linkId,type:linkData.linkType,value:linkData.linkValue}),contentType:"application/json",error:function(){editor.windowManager.close()},success:function(data){return angular.isUndefined(data.linkId)||0==data.linkId.length?void editor.windowManager.close():(editor.undoManager.transact(function(){editor.execCommand("mceInsertLink",!1,{href:"###"+data.linkId+"###"})}),void editor.windowManager.close())}})}},{text:"Close",onclick:"close"}]})},stateSelector:"a[href]"}),editor.addButton("unlink42",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"})});