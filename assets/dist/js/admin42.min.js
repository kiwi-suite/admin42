angular.module("admin42",["ui.bootstrap","ui.bootstrap.datetimepicker","ngAnimate","ngSanitize","ui.utils","smart-table","toaster","ngStorage","ui.sortable","ui.select","angularFileUpload"]),angular.module("admin42").config(["$httpProvider",function($httpProvider){$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]),angular.module("admin42").directive("delete",[function(){return{restrict:"E",templateUrl:"element/delete.html",scope:{callback:"="},controller:["$scope","$attrs","$modal","$window","$parse",function($scope,$attrs,$modal,$window){$scope.size=angular.isUndefined($attrs.size)?"lg":"lg"!=$attrs.size&&"sm"!=$attrs.size&&"xs"!=$attrs.size?"lg":$attrs.size,$scope.method=angular.isUndefined($attrs.method)?"post":"post"!=$attrs.method&&"delete"!=$attrs.method?"post":$attrs.method,$scope["delete"]=function(){var modalInstance=$modal.open({animation:!0,templateUrl:"element/delete-modal.html",controller:"DeleteModalController",resolve:{requestUrl:function(){return $attrs.url},requestParams:function(){var params={};return angular.forEach($attrs,function(value,key){"request"==key.substring(0,7)&&(this[key.substring(7).toLowerCase()]=value)},params),params},requestTitle:function(){return $attrs.title},requestContent:function(){return $attrs.content},requestMethod:function(){return $scope.method}}});modalInstance.result.then(function(data){return angular.isDefined(data.redirect)?void($window.location.href=data.redirect):void(angular.isDefined($scope.callback)&&$scope.callback())},function(){})}}]}}]),angular.module("admin42").controller("DeleteModalController",["$scope","$modalInstance","$http","requestUrl","requestParams","requestTitle","requestContent","requestMethod",function($scope,$modalInstance,$http,requestUrl,requestParams,requestTitle,requestContent,requestMethod){$scope.title=requestTitle,$scope.content=requestContent,$scope.ok=function(){$http({method:requestMethod.toUpperCase(),url:requestUrl,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:requestParams,transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")}}).success(function(data){$modalInstance.close(data)}).error(function(){$modalInstance.dismiss("cancel")})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("admin42").directive("adminDynamicForm",[function(){return{restrict:"A",scope:{templateName:"@",adminDynamicFormElements:"@",adminDynamicPrototypes:"@"},templateUrl:function(elem,attrs){return attrs.baseForm},controller:["$scope","jsonCache",function($scope,jsonCache){$scope.data={},$scope.elements=jsonCache.get($scope.adminDynamicFormElements),$scope.prototypes=jsonCache.get($scope.adminDynamicPrototypes),$scope.data.selectedPrototype=$scope.prototypes[0],$scope.addTemplate=function(){var element=angular.copy($scope.data.selectedPrototype);element.internIndex=$scope.elements.length,$scope.elements.push(element)},$scope.sortableOptions={axis:"y",opacity:.5,handle:".panel-sort-handle",items:"> .sortable-container",placeholder:"sortable-placeholder",start:function(){$scope.$broadcast("$tinyWysiwyg:disable"),$scope.$emit("$tinyWysiwyg:disable")},stop:function(){$scope.$broadcast("$tinyWysiwyg:enable"),$scope.$emit("$tinyWysiwyg:enable")}}}]}}]),angular.module("admin42").directive("dynamicModel",["$compile",function($compile){return{link:function(scope,element,attrs){scope.$watch(attrs.dynamicModel,function(dynamicModel){attrs.ngModel!=dynamicModel&&dynamicModel&&(element.attr("ng-model",dynamicModel),""==dynamicModel&&element.removeAttr("ng-model"),element.unbind(),$compile(element)(scope))})}}}]),angular.module("admin42").directive("uiFullscreen",["$document",function($document){return{restrict:"AC",template:'<i class="fa fa-expand fa-fw text"></i><i class="fa fa-compress fa-fw text-active"></i>',link:function(scope,el,attr){el.addClass("hide"),screenfull.enabled&&!navigator.userAgent.match(/Trident.*rv:11\./)&&el.removeClass("hide"),el.on("click",function(){var target;attr.target&&(target=$(attr.target)[0]),screenfull.toggle(target)}),$document.on(screenfull.raw.fullscreenchange,function(){screenfull.isFullscreen?el.addClass("active"):el.removeClass("active")})}}}]),angular.module("admin42").factory("jsonCache",["$cacheFactory",function($cacheFactory){return $cacheFactory("json-cache")}]).directive("script",["jsonCache",function(jsonCache){return{restrict:"E",terminal:!0,compile:function(element,attr){if("application/json"==attr.type){var jsonHandler=attr.id,json=angular.fromJson(element[0].text);jsonCache.put(jsonHandler,json)}}}}]),angular.module("admin42").directive("uiNav",[function(){return{restrict:"AC",link:function(scope,el){var next,_window=$(window),_mb=768,wrap=$(".app-aside"),backdrop=".dropdown-backdrop";el.on("click","a",function(e){next&&next.trigger("mouseleave.nav");var _this=$(this);_this.parent().siblings(".active").toggleClass("active"),_this.next().is("ul")&&_this.parent().toggleClass("active")&&e.preventDefault(),_this.next().is("ul")||_window.width()<_mb&&$(".app-aside").removeClass("show off-screen")}),el.on("mouseenter","a",function(e){if(next&&next.trigger("mouseleave.nav"),$("> .nav",wrap).remove(),!(!$(".app-aside-fixed.app-aside-folded").length||_window.width()<_mb||$(".app-aside-dock").length)){var top,_this=$(e.target),w_h=$(window).height(),offset=50,min=150;!_this.is("a")&&(_this=_this.closest("a")),_this.next().is("ul")&&(next=_this.next(),_this.parent().addClass("active"),top=_this.parent().position().top+offset,next.css("top",top),top+next.height()>w_h&&next.css("bottom",0),top+min>w_h&&next.css("bottom",w_h-top-offset).css("top","auto"),next.appendTo(wrap),next.on("mouseleave.nav",function(){$(backdrop).remove(),next.appendTo(_this.parent()),next.off("mouseleave.nav").css("top","auto").css("bottom","auto"),_this.parent().removeClass("active")}),$(".smart").length&&$('<div class="dropdown-backdrop"/>').insertAfter(".app-aside").on("click",function(next){next&&next.trigger("mouseleave.nav")}))}}),wrap.on("mouseleave",function(){next&&next.trigger("mouseleave.nav"),$("> .nav",wrap).remove()})}}}]),angular.module("admin42").directive("ngInitial",function(){return{restrict:"A",controller:["$scope","$element","$attrs","$parse",function($scope,$element,$attrs,$parse){var getter,setter,val,tag;tag=$element[0].tagName.toLowerCase(),val=$attrs.initialValue||$element.val(),"input"===tag&&("checkbox"===$element.attr("type")?val=$element[0].checked?!0:void 0:"radio"===$element.attr("type")&&(val=$element[0].checked||void 0!==$element.attr("selected")?$element.val():void 0)),$attrs.ngModel&&(getter=$parse($attrs.ngModel),(setter=getter.assign)($scope,val))}]}}),angular.module("smart-table").directive("stSearch42",["stConfig","$timeout",function(stConfig,$timeout){return{require:"^stTable",link:function(scope,element,attr,ctrl){var tableCtrl=ctrl,promise=null,throttle=attr.stDelay||stConfig.search.delay;attr.$observe("stSearch42",function(newValue,oldValue){var input=element[0].value;newValue!==oldValue&&input&&tableCtrl.search(input,newValue)}),scope.$watch(function(){return ctrl.tableState().search},function(newValue){var predicateExpression=attr.stSearch42||"$";newValue.predicateObject&&newValue.predicateObject[predicateExpression]!==element[0].value&&(element[0].value=newValue.predicateObject[predicateExpression]||"")},!0),element.bind("input",function(evt){evt=evt.originalEvent||evt,null!==promise&&$timeout.cancel(promise),promise=$timeout(function(){tableCtrl.search(evt.target.value,attr.stSearch42||""),promise=null},throttle)})}}}]),angular.module("admin42").directive("tinyWysiwyg",["$timeout","$window",function($timeout){var editorCounter=0,idPrefix="tiny-wysiwyg";return{link:function(scope,element,attrs){var tinyInstance;attrs.$set("id",idPrefix+"-"+editorCounter++);var expression={};angular.extend(expression,scope.$eval(attrs.tinyWysiwyg));var options={format:"raw",selector:"#"+attrs.id};angular.extend(options,expression),$timeout(function(){tinymce.init(options),tinyInstance=tinymce.get(attrs.id)}),scope.$on("$tinyWysiwyg:disable",function(){tinymce.execCommand("mceRemoveEditor",!1,attrs.id)}),scope.$on("$tinyWysiwyg:enable",function(){tinymce.execCommand("mceAddEditor",!1,attrs.id)})}}}]),angular.module("admin42").filter("bytes",function(){return function(bytes){if(isNaN(parseFloat(bytes))||!isFinite(bytes)||0==bytes)return"0";var measure,floor,precision,units={1:"KB",2:"MB",3:"GB",4:"TB"};return bytes>0xffffffffff?measure=4:bytes>1048575999&&0xffffffffff>=bytes?measure=3:bytes>1024e3&&1048575999>=bytes?measure=2:1024e3>=bytes&&(measure=1),floor=Math.floor(bytes/Math.pow(1024,measure)).toString().length,precision=floor>3?0:3-floor,(bytes/Math.pow(1024,measure)).toFixed(precision)+" "+units[measure]}}),angular.module("admin42").filter("datetime",function(appConfig){return function(input,emptyValue,format,timezone){angular.isUndefined(emptyValue)&&(emptyValue="-"),angular.isUndefined(format)&&(format=appConfig.defaultDateTimeFormat),angular.isUndefined(timezone)&&(timezone=appConfig.timezone);var dateTime;if(angular.isObject(input)&&"Date"==input.constructor.name)dateTime=moment.tz(input,input.timezone);else if(angular.isObject(input)){if(angular.isUndefined(input.date))return emptyValue;dateTime=moment.tz(input.date,input.timezone)}else{if(!angular.isString(input))return emptyValue;if(0==input.length)return emptyValue;dateTime=moment.tz(input,timezone)}return dateTime.locale(appConfig.locale),dateTime.format(format)}}),angular.module("admin42").controller("AppController",["$scope","toaster","$timeout","$localStorage",function($scope,toaster,$timeout,$localStorage){$scope.app={$storage:$localStorage.$default({asideFolded:!1})},$scope.app.appContentFull=!1,"undefined"!=typeof FLASH_MESSAGE&&$timeout(function(){angular.forEach(FLASH_MESSAGE,function(messages,namespace){0!=messages.length&&angular.forEach(messages,function(message){toaster.pop(namespace,message.title,message.message)})})},1e3)}]),angular.module("admin42").controller("CropController",["$scope","$http","$timeout","Cropper","jsonCache","$attrs","$interval",function($scope,$http,$timeout,Cropper,jsonCache,$attrs,$interval){function stopInterval(){$interval.cancel(stop)}$scope.data=[],$scope.dimensions=jsonCache.get($attrs.json).dimension,$scope.meta=jsonCache.get($attrs.json).meta,$scope.selectedHandle=$attrs.mediaSelector,$scope.isActive=function(handle){return handle==$scope.selectedHandle?"active":""},$scope.hasChanges=function(handle){return angular.isUndefined($scope.data[handle])?!1:!0},$scope.saveCroppedImage=function(handle,url){return angular.isUndefined($scope.data[handle])?!1:(url=url.replace("{{ name }}",handle),void $http.post(url,$scope.data[handle]))},$scope.selectDimension=function(handle){$scope.selectedHandle=handle,Cropper.getJqueryCrop().cropper("destroy");var dimension=$scope.dimensions[handle],options={crop:function(dataNew){$scope.data[$scope.selectedHandle]=dataNew},responsive:!0,autoCrop:!1,rotatable:!1,zoomable:!1,guides:!1,built:function(){angular.isUndefined($scope.meta[handle])?$(this).cropper("setCropBoxData",{x:0,y:0,width:dimension.width,height:dimension.height}):(console.log($scope.meta[handle]),$(this).cropper("setCropBoxData",{x:0,y:0,width:500,height:500})),$(this).cropper("crop")}};"auto"!=dimension.width&&"auto"!=dimension.height&&(options.aspectRatio=dimension.width/dimension.height),Cropper.getJqueryCrop().on("dragmove.cropper",function(e){var $cropper=$(e.target),data=$cropper.cropper("getCropBoxData"),imageData=$cropper.cropper("getImageData");return"auto"!=dimension.width&&data.width<dimension.width/(imageData.naturalWidth/imageData.width)?!1:"auto"!=dimension.height&&data.height<dimension.height/(imageData.naturalHeight/imageData.height)?!1:!0}).on("dragstart.cropper",function(e){var $cropper=$(e.target),data=$cropper.cropper("getCropBoxData"),imageData=$cropper.cropper("getImageData"),hasChanged=!1;if("auto"!=dimension.width){var width=dimension.width/(imageData.naturalWidth/imageData.width);(angular.isUndefined(data.width)||data.width<width)&&(data.width=width,hasChanged=!0)}if("auto"!=dimension.height){var height=dimension.height/(imageData.naturalHeight/imageData.height);(angular.isUndefined(data.height)||data.height<height)&&(data.height=height,hasChanged=!0)}hasChanged&&$(e.target).cropper("setCropBoxData",data)}),Cropper.getJqueryCrop().cropper(options)};var stop=$interval(function(){null!=Cropper.getJqueryCrop()&&($scope.selectDimension($scope.selectedHandle),stopInterval())},100)}]),angular.module("admin42").directive("ngCropper",["Cropper",function(Cropper){return{restrict:"A",link:function(scope,element){Cropper.setJqueryCrop(element)}}}]).service("Cropper",[function(){this.crop=null,this.setJqueryCrop=function(crop){this.crop=crop},this.getJqueryCrop=function(){return this.crop}}]),angular.module("admin42").controller("DataGridController",["$scope","$http","$attrs",function($scope,$http,$attrs){var url=$attrs.url;$scope.collection=[],$scope.isLoading=!0,$scope.displayedPages=1,$scope.callServer=function(tableState){$scope.collection=[],$scope.isLoading=!0,$http.post(url,tableState).success(function(data){$scope.isLoading=!1,$scope.collection=data.data,$scope.displayedPages=data.meta.displayedPages,tableState.pagination.numberOfPages=data.meta.displayedPages}).error(function(){})}}]),angular.module("admin42").controller("AdminDatepickerController",["$scope","$attrs",function($scope){$scope.opened=!1,$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0},$scope.dateOptions={formatYear:"yy",startingDay:1,enableDate:!0,enableTime:!0,"class":"datepicker",showWeeks:!1,timeText:"Time",startingDay:1}}]),angular.module("admin42").controller("FileSelectorController",["$scope","$attrs","jsonCache","$modal",function($scope,$attrs,jsonCache,$modal){$scope.media=jsonCache.get($attrs.jsonDataId),$scope.tabs={media:{active:"file"!==$attrs.ngType,disabled:!1},sitemap:{active:"file"===$attrs.ngType,disabled:"file"!==$attrs.ngType}},$scope.clearMedia=function(){$scope.media=[]},$scope.isImage=function(){return angular.isUndefined($scope.media.mimeType)?!1:"image/"==$scope.media.mimeType.substr(0,6)},$scope.selectMedia=function(){var modalInstance=$modal.open({animation:!0,templateUrl:$attrs.modalTemplate,controller:"MediaModalSelectorController",size:"lg"});modalInstance.result.then(function(media){null!==media&&($scope.media=media)},function(){})}}]),angular.module("admin42").controller("MediaModalSelectorController",["$scope","$modalInstance",function($scope,$modalInstance){var selectedMedia=null;$scope.selectMedia=function(media){return $scope.selectedMedia==media.id?($scope.selectedMedia=null,void(selectedMedia=null)):($scope.selectedMedia=media.id,void(selectedMedia=media))},$scope.ok=function(){$modalInstance.close(selectedMedia)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("admin42").controller("MediaController",["$scope","FileUploader","$attrs","$http","toaster",function($scope,FileUploader,$attrs,$http){function requestFromServer(url,tableState){$scope.collection=[],$scope.isLoading=!0,$http.post(url,tableState).success(function(data){$scope.isLoading=!1,$scope.collection=data.data,$scope.displayedPages=data.meta.displayedPages,tableState.pagination.numberOfPages=data.meta.displayedPages}).error(function(){})}var currentTableState={},url=$attrs.url;$scope.isCollapsed=!0,$scope.collection=[],$scope.isLoading=!0,$scope.displayedPages=1,$scope.errorFiles=[];var uploader=$scope.uploader=new FileUploader({url:$attrs.uploadUrl,filters:[{name:"filesize",fn:function(item){return console.log(item.size),item.size>$attrs.maxFileSize?($scope.errorFiles.push(item),!1):!0}}]});uploader.onCompleteAll=function(){requestFromServer(url,currentTableState),$scope.errorFiles=[]},$scope.isImage=function(item){return"image/"==item.mimeType.substr(0,6)},$scope.getDocumentClass=function(){return"fa-file"},$scope.callServer=function(tableState){currentTableState=tableState,requestFromServer(url,tableState)}}]),angular.module("admin42").controller("ModalController",["$scope","$modalInstance",function($scope,$modalInstance){$scope.ok=function(){$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("admin42").controller("NotificationController",["$scope","$interval","$http","$attrs",function($scope,$interval,$http,$attrs){var notificationUrl=$attrs.notificationUrl,updateNotifications=function(){$http.get(notificationUrl).success(function(data){$scope.notifications=data}).error(function(){$scope.notifications=[]})};$scope.notifications=[],$interval(updateNotifications,3e4),updateNotifications(),$scope.clearNotifications=function(clearUrl){$http.post(clearUrl).success(function(){$scope.notifications=[]}).error(function(){})}}]),angular.module("admin42").controller("SelectController",["$scope","$attrs","jsonCache",function($scope,$attrs,jsonCache){$scope.items=jsonCache.get($attrs.jsonDataId),$scope.item={},$attrs.initValue.length>0&&angular.forEach($scope.items,function(value){value.id==$attrs.initValue&&($scope.item.selected=value)})}]),angular.module("admin42").controller("WysiwygController",function($scope,$attrs){function fileBrowser(field_name,url,type,win){function handleSelection($selectedItem){var data={};data.url=$selectedItem.find("img").attr("src")||$selectedItem.attr("href"),data.url=data.url.trim(),data.title=$selectedItem.find("img").attr("alt")||$selectedItem.attr("title"),data.title=data.title.trim();var $urlInput=$("#"+field_name);switch($urlInput.val(data.url),type){case"file":data.text=data.text||$selectedItem.text(),data.text=data.text.trim(),data["class"]="site-link";var $displayTextInput=$urlInput.parents(".mce-formitem").next().find("input");""===$displayTextInput.val()&&$displayTextInput.val(data.text);var $titleTextInput=$displayTextInput.parents(".mce-formitem").next().find("input");""===$titleTextInput.val()&&$titleTextInput.val(data.title);break;case"image":var $imageDescritpionInput=$urlInput.parents(".mce-formitem").next().find("input");""===$imageDescritpionInput.val()&&$imageDescritpionInput.val(data.title);break;case"media":}console.log(type,data),top.tinymce.activeEditor.windowManager.close()}var fileBrowserUrl=$attrs.ngFileBrowser,dialogTitles=angular.fromJson($attrs.ngFileBrowserTitles)||{};if(!fileBrowserUrl)return void alert("File browser URL missing (ng-file-browser)");fileBrowserUrl+="?type="+type;var current=$("#"+field_name).val();""!==current&&(fileBrowserUrl+="&current="+encodeURIComponent(current));var dialog=tinymce.activeEditor.windowManager.open({file:fileBrowserUrl,title:dialogTitles[type]||"File Browser",width:800,height:450,resizable:"yes",inline:"yes",close_previous:"yes",buttons:[{text:"Cancel",onclick:function(){top.tinymce.activeEditor.windowManager.close()}}]},{field_name:field_name,type:type,win:win,handleSelection:handleSelection});return $("#"+dialog._id).find("iframe").load(function(){var dialog=$($(this).get(0).contentDocument);$("a.selectable",dialog).click(function(e){e.preventDefault(),handleSelection($(this))})}),!1}$attrs.ngBaseUrl&&(tinymce.baseURL=$attrs.ngBaseUrl),$scope.tinymceOptionsFull={trusted:!0,format:"raw",file_browser_callback:fileBrowser,plugins:"paste advlist autolink lists charmap table code",image_advtab:!0,menubar:!1,toolbar:"undo redo paste | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | table code | ",skin:"lightgray",theme:"modern",elementpath:!1,resize:!0}});